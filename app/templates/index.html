{% extends "base.html" %}
{% block content %}

    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <div class="row">
                    <div class="container">
                        <p>Welcome to CitySentiment! Below is a map of Edinburgh with an overlay of the sentiment
                            of parts of the city. The more blue a region is, the more positive the comments coming from
                            that region are. The more red, the more negative. Please select the dates for which you
                            would
                            like to see the sentiment for.</p>
                    </div>
                    <div class="container">
                        <div id="map-canvas"></div>
                    </div>

                    <div class="container">
                        <div id="slider" class="col-md-9 pull-left"></div>
                        <div class="col-md-1 pull-left"><h3 id="slider_value"></h3></div>

                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}

    <script src="https://maps.googleapis.com/maps/api/js?libraries=visualization,drawing,key=AIzaSyBmROUiZ37aAcA_dxjlwnkdmEBW3qIxos0"></script>

    <script>
        // Not sure if this works like this
        var pointArray;
        var map, heatmap;

        $(document).ready(function () {

            var sentimentData = [
                {location: new google.maps.LatLng(55.959472, -3.249847), weight: 3}
            ];

            function initialize() {
                var mapOptions = {
                    zoom: 13,
                    center: new google.maps.LatLng(55.953, -3.188),
                    mapTypeId: google.maps.MapTypeId.ROADMAP
                };

                map = new google.maps.Map(document.getElementById('map-canvas'),
                        mapOptions);

                // Change this to change heatmap
                pointArray = new google.maps.MVCArray(sentimentData);

                heatmap = new google.maps.visualization.HeatmapLayer({
                    data: pointArray
                });
                heatmap.setMap(map);

            }

            function toggleHeatmap() {
                heatmap.setMap(heatmap.getMap() ? null : map);
            }

            function changeGradient() {
                var gradient = [
                    'rgba(165,0,38, 0)',
                    'rgb(222,119,174)',
                    'rgb(253,224,239)',
                    'rgb(230,245,208)',
                    'rgb(184,225,134)',
                    'rgb(127,188,65)'
                ]
                heatmap.set('gradient', heatmap.get('gradient') ? null : gradient);
            }

            function changeRadius() {
                heatmap.set('radius', heatmap.get('radius') ? null : 30);
            }

            function changeOpacity() {
                heatmap.set('opacity', heatmap.get('opacity') ? null : 1);
            }

            google.maps.event.addDomListener(window, 'load', initialize);

            function startup() {
                changeRadius();
                changeOpacity();
                changeGradient();
            }

        });

        function formatDate(d) {

            var day = d.getDate();
            var year = d.getYear();
            var month = -1;
            if (d.getMonth() < 9) {
                month = "0" + (d.getMonth()+1) ;
            } else {
                month = (d.getMonth()+1);
            }
            return day + "/"
                + month + "/"
                + year;
        }
{#        var initialDate = "15/02/2015";#}
        var initialDate = new Date(15,01,27);
{#        initialDate.setDate(initialDate.getDate() + 2);#}
        var dateString = formatDate(initialDate);
        $("#slider_value").html(dateString);
        $("#slider").slider({
            //TODO Should be this and make dynamic with hours and days
{#            value: initialDate,#}
            value: 0,
            min: 0,
            max: 10,
            slide: function (event, ui) {
                var newDate = new Date(initialDate);
                newDate.setDate(initialDate.getDate() + ui.value);
                var dateString = formatDate(newDate);
{#                var newDate = initialDate.getDate() + 1;#}
                $("#slider_value").html(dateString);
            },
            stop: function (event, ui) {
                console.log(ui);
                $.ajax("/get_coords", {
                    data: {'offset': ui.value, 'initial_date': formatDate(initialDate)},
                    method: "POST",
                    complete: function (a, b) {
                        var respJSON = $.parseJSON(a.responseText);

                        //TODO Delete
                        var sentimentData = [];
                        pointArray.clear();

                        for (var i = 0; i < respJSON["points"].length; i++) {
                            sentimentData.push({location: new google.maps.LatLng(respJSON["points"][i]["location"][0], respJSON["points"][i]["location"][1]),
                                weight: respJSON["points"][i]["weight"]});

                        }
                        // Change this to change heatmap

                        pointArray = new google.maps.MVCArray(sentimentData);
                        heatmap.setData(pointArray)

                    }
                })
            }
        });
    </script>
{% endblock %}