{% extends "base.html" %}
{% block content %}

    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <div class="row">
                    <div class="container">
                        <p>Welcome to CitySentiment! Below is a map of Edinburgh with an overlay of the sentiment
                            of parts of the city. The more blue a region is, the more positive the comments coming from
                            that region are. The more red, the more negative. Please select the dates for which you
                            would
                            like to see the sentiment for.</p>
                    </div>
                    <div class="container">
                        <div id="map-canvas"></div>
                    </div>

                    <div class="container">
                        <div id="slider" class="col-md-9 pull-left"></div>
                        <div class="col-md-1 pull-left"><h3 id="slider_value"></h3></div>

                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}

    <script
		src="https://maps.googleapis.com/maps/api/js?libraries=visualization,drawing,key=AIzaSyBmROUiZ37aAcA_dxjlwnkdmEBW3qIxos0">
    </script>
    <script src={{ url_for('static', filename='js/mapOptions.js')}}></script>
    <script src={{ url_for('static', filename='js/negatives.js')}}></script>
    <script src={{ url_for('static', filename='js/positives.js')}}></script>

    <script>

        // Not sure if this works like this
        var posCircle, negCircle, map;
        function initialize() {
            // Create the map
            var mapDiv = document.getElementById('map-canvas');
            map = new google.maps.Map(mapDiv, mapOptions);
            // Specify map style
            map.setOptions({styles: styles});
            google.maps.event.addDomListener(mapDiv, 'click', addCircles);
        }

        function addCircles() {

            for (var circle in positives) {
                var positiveOptions = {
                    strokeColor: '#FFFF00',
                    strokeOpacity: 0.8,
                    strokeWeight: 0,
                    fillColor: '#FF0000',
                    fillOpacity: 0.6,
                    map: map,
                    center: positives[circle],
                    radius: 300
                };
                // Add this circle to the map
                posCircle = new google.maps.Circle(positiveOptions);
            }

            for (var circle in negatives) {
                var negativeOptions = {
                    strokeColor: '#0000FF',
                    strokeOpacity: 0.8,
                    strokeWeight: 0,
                    fillColor: '#0000FF',
                    fillOpacity: 0.6,
                    map: map,
                    center: positives[circle],
                    radius: 300
                };
                // Add this circle to the map
                negCircle = new google.maps.Circle(negativeOptions);
            }

        }

        function showAlert() {
            window.alert('Jess is da best');
        }

        google.maps.event.addDomListener(window, 'load', initialize);

        function formatDate(d) {

            var day = d.getDate();
            var year = d.getYear();
            var month = -1;
            if (d.getMonth() < 9) {
                month = "0" + (d.getMonth()+1) ;
            } else {
                month = (d.getMonth()+1);
            }
            return day + "/"
                + month + "/"
                + year;
        }
{#        var initialDate = "15/02/2015";#}
        var initialDate = new Date(15,01,27);
{#        initialDate.setDate(initialDate.getDate() + 2);#}
        var dateString = formatDate(initialDate);
        $("#slider_value").html(dateString);
        $("#slider").slider({
            //TODO Should be this and make dynamic with hours and days
{#            value: initialDate,#}
            value: 0,
            min: 0,
            max: 10,
            slide: function (event, ui) {
                var newDate = new Date(initialDate);
                newDate.setDate(initialDate.getDate() + ui.value);
                var dateString = formatDate(newDate);
{#                var newDate = initialDate.getDate() + 1;#}
                $("#slider_value").html(dateString);
            },
            stop: function (event, ui) {
{#                console.log(ui);#}
                $.ajax("/get_coords", {
                    //TODO Change to calculate the new date here and just send that.
                    data: {'offset': ui.value, 'initial_date': formatDate(initialDate)},
                    method: "POST",
                    complete: function (a, b) {
                        var respJSON = $.parseJSON(a.responseText);
                        console.log(respJSON)
                        alert(respJSON["1"][0]['latitude'])
                        //TODO Delete
{#                        var sentimentData = [];#}
{#                        pointArray.clear();#}
{##}
{#                        for (var i = 0; i < respJSON["points"].length; i++) {#}
{#                            sentimentData.push({location: new google.maps.LatLng(respJSON["points"][i]["location"][0], respJSON["points"][i]["location"][1]),#}
{#                                weight: respJSON["points"][i]["weight"]});#}
{##}
{#                        }#}
{#                        // Change this to change heatmap#}
{##}
{#                        pointArray = new google.maps.MVCArray(sentimentData);#}
{#                        heatmap.setData(pointArray)#}

                    }
                })
            }
        });
    </script>
{% endblock %}